<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UN Bluebook Data Visualization</title>
  <!-- Libraries -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    #container { display:flex; height:100%; }
    #sidebar { width:300px; background:#f4f4f4; border-right:1px solid #ddd; padding:20px; box-sizing:border-box; transition:all .3s ease; overflow-y:auto; }
    #sidebar.collapsed { margin-left:-300px; }
    #sidebar h2 { margin-top:0; }
    .control-group { margin-bottom:20px; }
    .control-group label { font-weight:bold; display:block; margin-bottom:5px; }
    #metricsContainer { min-height:40px; border:1px dashed #ccc; padding:5px; }
    .chip { background:#007bff; color:#fff; padding:5px 10px; border-radius:16px; display:inline-block; margin:3px; cursor:move; }
    .chip .remove { margin-left:8px; cursor:pointer; }
    #addMetricBtn { margin-top:5px; }
    #availableMetrics { display:none; width:100%; margin-top:5px; }
    .color-picker { display:flex; align-items:center; margin-bottom:5px; }
    .color-picker label { margin-right:10px; }
    #toggleSidebar { position:absolute; top:10px; left:10px; background:#007bff; color:#fff; border:none; padding:8px; cursor:pointer; border-radius:4px; z-index:1000; }
    #main { flex:1; position:relative; padding:20px; overflow:auto; }
    #tabs { margin-bottom:10px; }
    .tab-button { padding:8px 16px; margin-right:5px; cursor:pointer; border:1px solid #ccc; background:#f9f9f9; border-radius:4px; }
    .tab-button.active { background:#007bff; color:#fff; border-color:#007bff; }
    .panel { display:none; }
    .panel.active { display:block; }
    table.dataTable { width:100% !important; cursor:pointer; }
    #nRange { width:100%; }
    /* Responsive */
    @media(max-width:768px) {
      #container { flex-direction:column; }
      #sidebar { position:absolute; width:80%; height:100%; top:0; left:0; margin-left:-80%; }
      #sidebar.collapsed { margin-left:0; }
      #main { padding:10px; }
      #toggleSidebar { display:block; }
    }
  </style>
</head>
<body>
  <button id="toggleSidebar" title="Toggle filters panel">‚ò∞ Filters</button>
  <div id="container">
    <aside id="sidebar">
      <h2>Filters & Settings</h2>
      <div class="control-group" title="Drag to reorder metrics, click ‚úï to remove">  
        <label data-tooltip="Active metrics: drag to reorder; click ‚úï to remove">Metrics</label>
        <div id="metricsContainer"></div>
        <button id="addMetricBtn" title="Click to add a metric">+ Add Metric</button>
        <select id="availableMetrics" title="Select a metric to add"></select>
      </div>
      <div class="control-group">
        <label data-tooltip="Pick colors for each metric">Metric Colors</label>
        <div id="colorPickers"></div>
      </div>
      <div class="control-group">
        <label for="chartTypeSelect" title="Choose chart display mode">Chart Type</label>
        <select id="chartTypeSelect">
          <option value="stack">Stacked Bar</option>
          <option value="group">Grouped Bar</option>
          <option value="percent">100% Stacked</option>
          <option value="pie">Pie (Top N Total)</option>
        </select>
      </div>
      <div id="advanced" class="control-group">
        <h4 title="Show or hide advanced filters">Advanced Options ‚ñ≤</h4>
        <div id="advanced-content">
          <label for="groupSelect" title="Filter by region group">Region Group</label>
          <select id="groupSelect"><option value="All">All</option></select>
          <label data-tooltip="Show all, top N, or bottom N entries">Display Mode</label>
          <div id="displayModeRadios">
            <label title="Show all"><input type="radio" name="displayMode" value="All" checked>All</label>
            <label title="Show top N"><input type="radio" name="displayMode" value="Top">Top N</label>
            <label title="Show bottom N"><input type="radio" name="displayMode" value="Bottom">Bottom N</label>
          </div>
          <label for="nRange" title="Adjust number of entries">N: <span id="nValue">10</span></label>
          <input type="range" id="nRange" min="1" value="10">
          <label for="searchInput" title="Type to filter by country">Search Country</label>
          <input type="text" id="searchInput" placeholder="Start typing...">
          <button id="downloadCsv" title="Download current filtered data as CSV">Download CSV</button>
        </div>
      </div>
    </aside>
    <div id="main">
      <h1 data-tooltip="Use the filters to customize charts">UN Bluebook Data Visualization üéâ</h1>
      <div id="tabs">
        <button id="tab-chart" class="tab-button active" title="View chart">üìä Chart</button>
        <button id="tab-table" class="tab-button" title="View table">üìã Table</button>
        <button id="tab-map" class="tab-button" title="View map">üó∫Ô∏è Map</button>
      </div>
      <div id="chart" class="panel active" style="width:100%;height:500px;"></div>
      <div id="table" class="panel"><table id="data-table" class="display"></table></div>
      <div id="map" class="panel" style="width:100%;height:500px;"></div>
    </div>
  </div>
  <script>
    // Initialize tooltips
    $(document).tooltip({ items: '[data-tooltip], [title]', content: function() { return $(this).data('tooltip') || $(this).attr('title'); } });

    $('#toggleSidebar').click(() => $('#sidebar').toggleClass('collapsed'));

    d3.csv('UN_Bluebook_Data.csv').then(data => {
      data.forEach(d => {
        d['Female Count']   = +d['Female Count'];
        d['Male Count']     = +d['Male Count'];
        d['Total Count']    = +d['Total Count'];
        d['Female Percent'] = +d['Female Percent'].replace('%','');
        d['Male Percent']   = +d['Male Percent'].replace('%','');
      });

      // Autocomplete
      const countries = data.map(d => d.Country);
      $('#searchInput').autocomplete({ source: countries, minLength: 1 });

      // Slider
      $('#nRange').attr('max', data.length).on('input change', function() { $('#nValue').text(this.value); updateAll(); });

      const allMetrics = ['Female Count','Male Count','Female Percent','Male Percent'];
      let currentMetrics = ['Female Count','Male Count'];
      const defaultColors = {
        'Female Count': '#ff69b4',
        'Male Count': '#1f77b4',
        'Female Percent': '#2ca02c',
        'Male Percent': '#d62728'
      };

      function renderChips() {
        const container = $('#metricsContainer').empty();
        currentMetrics.forEach(m => {
          const chip = $('<div>').addClass('chip').attr('data-metric', m).text(m);
          $('<span>').addClass('remove').html('‚úï').appendTo(chip).click(() => {
            currentMetrics = currentMetrics.filter(x => x !== m);
            renderChips();
            renderColorPickers();
            updateAll();
          });
          container.append(chip);
        });
        container.sortable({
          items: '.chip',
          axis: 'x',
          update: function() {
            currentMetrics = $('#metricsContainer .chip').map((i, el) => $(el).attr('data-metric')).get(); renderColorPickers(); updateAll();
          }
        });
        renderAvailable();
      }

      function renderAvailable() {
        const select = $('#availableMetrics').empty();
        allMetrics.filter(m => !currentMetrics.includes(m)).forEach(m =>
          select.append(`<option value="${m}">${m}</option>`)
        );
      }

      $('#addMetricBtn').click(() => $('#availableMetrics').toggle()).on('click', e => e.stopPropagation());
      $('#availableMetrics').change(function() {
        const m = $(this).val();
        if (m) {
          currentMetrics.push(m);
          renderChips();
          renderColorPickers();
          updateAll();
        }
        $(this).hide();
      });

      function renderColorPickers() {
        const container = d3.select('#colorPickers').html('');
        currentMetrics.forEach(m => {
          const div = container.append('div').attr('class', 'color-picker');
          div.append('label').text(m);
          div.append('input').attr('type', 'color').attr('data-metric', m).attr('value', defaultColors[m]);
        });
      }

      renderChips();
      renderColorPickers();

      // Populate region group select
      const groupSelect = d3.select('#groupSelect');
      Array.from(new Set(data.map(d => d.Group))).sort().forEach(g => groupSelect.append('option').attr('value', g).text(g));

      // Toggle advanced
      $('#advanced h4').click(() => $('#advanced-content').slideToggle());

      // Tab logic
      $('.tab-button').click(function() {
        const t = this.id.replace('tab-', '');
        $('.tab-button').removeClass('active');
        $(this).addClass('active');
        $('.panel').removeClass('active');
        $('#' + t).addClass('active');
        updateAll();
      });

      function getFilteredData() {
        let fd = data;
        const group = $('#groupSelect').val();
        if (group !== 'All') fd = fd.filter(d => d.Group === group);
        const term = $('#searchInput').val().toLowerCase();
        if (term) fd = fd.filter(d => d.Country.toLowerCase().includes(term));
        // Sort descending by Total Count
        fd.sort((a, b) => b['Total Count'] - a['Total Count']);
        const mode = $('input[name="displayMode"]:checked').val();
        const n = +$('#nRange').val();
        if (mode === 'Top') fd = fd.slice(0, n);
        if (mode === 'Bottom') fd = fd.slice(-n);
        return fd;
      }

      function updateAll() {
        const fd = getFilteredData();
        if ($('#chart').hasClass('active')) drawChart(fd);
        if ($('#table').hasClass('active')) drawTable(fd);
        if ($('#map').hasClass('active')) drawMap(fd);
      }

      function drawChart(fd) {
        if (!currentMetrics.length) { Plotly.purge('chart'); return; }
        const chartType = $('#chartTypeSelect').val();
        const categoriesAsc = fd.slice().reverse().map(d => d.Country);
        const yCats = fd.map(d => d.Country);
        const traces = currentMetrics.map(m => ({
          x: fd.map(d => d[m]),
          y: yCats,
          name: m,
          type: 'bar',
          orientation: 'h',
          marker: { color: $(`[data-metric='${m}']`).val() }
        }));
        const layout = {
          title: currentMetrics.join(' + ') + ' by Country',
          margin: { l:150, r:30, t:50, b:50 },
          yaxis: { categoryorder: 'array', categoryarray: categoriesAsc }
        };
        if (chartType === 'stack') layout.barmode = 'stack';
        if (chartType === 'group') layout.barmode = 'group';
        if (chartType === 'percent') { layout.barmode = 'stack'; layout.barnorm = 'percent'; }
        if (chartType === 'pie') {
          const labels = fd.map(d => d.Country);
          const values = fd.map(d => d['Total Count']);
          Plotly.newPlot('chart', [{ labels, values, type: 'pie' }], { title: 'Top N Total Count' }, { responsive: true });
        } else {
          Plotly.newPlot('chart', traces, layout, { responsive: true });
        }
        document.getElementById('chart').on('plotly_click', function(e) {
          const country = e.points[0].y;
          drawTable(data.filter(d => d.Country === country));
          drawMap(data.filter(d => d.Country === country));
        });
      }

      function drawTable(fd) {
        const cols = ['Country','Group','Female Count','Male Count','Total Count','Female Percent','Male Percent'];
        let thead = '<thead><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead>';
        let tbody = '<tbody>' + fd.map(d => '<tr>' + cols.map(c => `<td>${d[c]}</td>`).join('') + '</tr>').join('') + '</tbody>';
        const $table = $('#data-table');
        if ($.fn.DataTable.isDataTable($table)) {
          $table.DataTable().clear().destroy();
        }
        $table.html(thead + tbody);
        $table.DataTable({ paging: true, searching: true });
        $table.off('click').on('click', 'tbody tr', function() {
          const country = $(this).find('td:first').text();
          drawChart(data.filter(d => d.Country === country));
          drawMap(data.filter(d => d.Country === country));
        });
      }

      function drawMap(fd) {
        if (!currentMetrics.length) { Plotly.purge('map'); return; }
        const m = currentMetrics[0];
        const locs = fd.map(d => d.Country);
        const z = fd.map(d => d[m]);
        Plotly.newPlot('map', [{
          type: 'choropleth',
          locations: locs,
          locationmode: 'country names',
          z: z,
          colorscale: 'Blues',
          marker: { line: { color: 'white', width: 0.5 } }
        }],
        { title: m + ' by Country', geo: { projection: { type: 'equirectangular' } } },
        { responsive: true });
      }

      $('#displayModeRadios input, #groupSelect, #chartTypeSelect').on('change', updateAll);
      $('#downloadCsv').click(() => {
        const blob = new Blob([d3.csvFormat(getFilteredData())], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        $('<a>').attr({ href: url, download: 'bluebook_filtered.csv' })[0].click();
        URL.revokeObjectURL(url);
      });

      updateAll();
    }).catch(err => console.error(err));
  </script>
</body>
</html>
