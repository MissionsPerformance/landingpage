<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UN Bluebook Interactive Data</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js and Plotly for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js" charset="utf-8"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Flag Icon CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css"/>

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
        /* Custom styles for Plotly chart responsiveness */
        .js-plotly-plot .plotly .modebar {
            top: -10px !important;
        }
        /* Style for color input */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 32px;
            padding: 0;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Spotlight Modal Styles */
        #spotlight-modal {
            transition: opacity 0.3s ease;
        }
        #spotlight-modal:not(.hidden) {
            display: flex; /* Use flex for centering */
        }
        #spotlight-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }
        #spotlight-modal:not(.hidden) #spotlight-content {
            transform: scale(1);
        }
        /* Flag icon sizing */
        .fi {
            line-height: 1;
            background-size: contain;
            background-position: 50%;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="h-screen w-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-800 text-white p-4 flex items-center shadow-md z-20 flex-shrink-0">
            <button id="sidebar-toggle" class="p-2 mr-4 rounded-md hover:bg-gray-700 md:hidden">
                <i data-lucide="filter" class="w-5 h-5"></i>
            </button>
            <h1 class="text-xl font-bold">UN Bluebook Interactive Data</h1>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity md:hidden opacity-0 pointer-events-none"></div>
            <aside id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-white shadow-xl z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:flex-shrink-0">
                <div class="p-5 overflow-y-auto h-full">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Filters & Settings</h2>
                        <button id="sidebar-close" class="p-2 rounded-md hover:bg-gray-200 md:hidden">
                           <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Metrics Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Metrics</label>
                        <div id="metrics-container" class="space-y-2"></div>
                    </div>
                    
                    <!-- Metric Colors -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Metric Colors</label>
                        <div id="color-pickers-container" class="space-y-2"></div>
                    </div>


                    <!-- Chart Type -->
                    <div class="mb-6">
                        <label for="chartTypeSelect" class="block text-sm font-semibold text-gray-700 mb-2">Chart Type</label>
                        <select id="chartTypeSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="stack">Stacked Bar</option>
                            <option value="group">Grouped Bar</option>
                            <option value="percent">100% Stacked Bar</option>
                            <option value="pie">Pie (by Total Count)</option>
                        </select>
                    </div>

                    <!-- Region Group -->
                    <div class="mb-6">
                        <label for="regionSelect" class="block text-sm font-semibold text-gray-700 mb-2">Region Group</label>
                        <select id="regionSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                             <option value="All">All Regions</option>
                        </select>
                    </div>

                    <!-- Display Mode -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Display Mode</label>
                        <div id="displayModeContainer" class="flex space-x-2 bg-gray-100 p-1 rounded-md">
                           <button data-mode="All" class="w-full py-1 text-sm rounded-md bg-transparent text-gray-600 hover:bg-gray-200">All</button>
                           <button data-mode="Top" class="w-full py-1 text-sm rounded-md bg-white text-blue-600 shadow">Top</button>
                           <button data-mode="Bottom" class="w-full py-1 text-sm rounded-md bg-transparent text-gray-600 hover:bg-gray-200">Bottom</button>
                        </div>
                    </div>

                    <!-- N Range Slider -->
                    <div id="n-range-container" class="mb-6">
                        <label for="nRange" class="block text-sm font-semibold text-gray-700 mb-2">Number of Countries: <span id="nValue" class="font-bold text-blue-600">15</span></label>
                        <input type="range" id="nRange" min="1" max="50" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                    </div>
                    
                    <!-- Search Input -->
                    <div class="mb-6">
                        <label for="searchInput" class="block text-sm font-semibold text-gray-700 mb-2">Search Country</label>
                        <input type="text" id="searchInput" placeholder="e.g., Canada" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>

                    <!-- Download Button -->
                    <div class="pt-4 border-t border-gray-200">
                         <button id="download-csv" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Download CSV
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-4 sm:p-6 lg:p-8 bg-gray-50 overflow-auto">
                <div class="w-full max-w-7xl mx-auto">
                    <!-- Tab Navigation -->
                    <div class="mb-6">
                        <div class="border-b border-gray-200">
                            <nav id="tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                                <button data-tab="Chart" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Chart</button>
                                <button data-tab="Table" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Table</button>
                                <button data-tab="Map" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Map</button>
                            </nav>
                        </div>
                    </div>
                    <!-- Content Panels -->
                    <div id="chart-panel" class="panel bg-white p-4 rounded-lg shadow-sm"></div>
                    <div id="table-panel" class="panel hidden bg-white p-4 rounded-lg shadow-sm overflow-x-auto"></div>
                    <div id="map-panel" class="panel hidden bg-white p-4 rounded-lg shadow-sm"></div>
                    <div id="loading" class="text-center p-10 text-xl font-semibold">Loading Data...</div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Country Spotlight Modal -->
    <div id="spotlight-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div id="spotlight-content" class="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-y-auto p-6 relative">
             <button id="spotlight-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
             </button>
             <h2 id="spotlight-title" class="text-3xl font-bold mb-4 border-b pb-2 flex items-center"></h2>
             <div id="spotlight-body" class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                <div id="spotlight-stats-un" class="space-y-2">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-1">UN Contribution</h3>
                </div>
                <div id="spotlight-stats-country" class="space-y-2">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-1">Country Information</h3>
                </div>
                 <div id="spotlight-stats-mission" class="space-y-2">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-1">Mission Contact</h3>
                </div>
                <div id="spotlight-chart" class="md:col-span-3" style="min-height: 250px;"></div>
             </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State & Elements ---
            let allData = [];
            let filteredData = [];
            const ALL_METRICS = ['Female Count', 'Male Count', 'Total Count', 'Female Percent', 'Male Percent'];
            let plotlyListenerAttached = false;
            
            // --- Country Name to ISO Code Mapping ---
            const countryCodeMap = {
                'Afghanistan': 'af', 'Albania': 'al', 'Algeria': 'dz', 'Andorra': 'ad', 'Angola': 'ao',
                'Antigua and Barbuda': 'ag', 'Argentina': 'ar', 'Armenia': 'am', 'Australia': 'au', 'Austria': 'at',
                'Azerbaijan': 'az', 'Bahamas': 'bs', 'Bahrain': 'bh', 'Bangladesh': 'bd', 'Barbados': 'bb',
                'Belarus': 'by', 'Belgium': 'be', 'Belize': 'bz', 'Benin': 'bj', 'Bhutan': 'bt',
                'Bolivia (Plurinational State of)': 'bo', 'Bosnia and Herzegovina': 'ba', 'Botswana': 'bw',
                'Brazil': 'br', 'Brunei Darussalam': 'bn', 'Bulgaria': 'bg', 'Burkina Faso': 'bf', 'Burundi': 'bi',
                'Cabo Verde': 'cv', 'Cambodia': 'kh', 'Cameroon': 'cm', 'Canada': 'ca', 'Central African Republic': 'cf',
                'Chad': 'td', 'Chile': 'cl', 'China': 'cn', 'Colombia': 'co', 'Comoros': 'km', 'Congo': 'cg',
                'Costa Rica': 'cr', "Côte d'Ivoire": 'ci', 'Croatia': 'hr', 'Cuba': 'cu', 'Cyprus': 'cy',
                'Czechia': 'cz', "Democratic People's Republic of Korea": 'kp', 'Democratic Republic of the Congo': 'cd',
                'Denmark': 'dk', 'Djibouti': 'dj', 'Dominica': 'dm', 'Dominican Republic': 'do', 'Ecuador': 'ec',
                'Egypt': 'eg', 'El Salvador': 'sv', 'Equatorial Guinea': 'gq', 'Eritrea': 'er', 'Estonia': 'ee',
                'Eswatini': 'sz', 'Ethiopia': 'et', 'Fiji': 'fj', 'Finland': 'fi', 'France': 'fr', 'Gabon': 'ga',
                'Gambia': 'gm', 'Georgia': 'ge', 'Germany': 'de', 'Ghana': 'gh', 'Greece': 'gr', 'Grenada': 'gd',
                'Guatemala': 'gt', 'Guinea': 'gn', 'Guinea-Bissau': 'gw', 'Guyana': 'gy', 'Haiti': 'ht',
                'Honduras': 'hn', 'Hungary': 'hu', 'Iceland': 'is', 'India': 'in', 'Indonesia': 'id',
                'Iran (Islamic Republic of)': 'ir', 'Iraq': 'iq', 'Ireland': 'ie', 'Israel': 'il', 'Italy': 'it',
                'Jamaica': 'jm', 'Japan': 'jp', 'Jordan': 'jo', 'Kazakhstan': 'kz', 'Kenya': 'ke', 'Kiribati': 'ki',
                'Kuwait': 'kw', 'Kyrgyzstan': 'kg', "Lao People's Democratic Republic": 'la', 'Latvia': 'lv',
                'Lebanon': 'lb', 'Lesotho': 'ls', 'Liberia': 'lr', 'Libya': 'ly', 'Liechtenstein': 'li',
                'Lithuania': 'lt', 'Luxembourg': 'lu', 'Madagascar': 'mg', 'Malawi': 'mw', 'Malaysia': 'my',
                'Maldives': 'mv', 'Mali': 'ml', 'Malta': 'mt', 'Marshall Islands': 'mh', 'Mauritania': 'mr',
                'Mauritius': 'mu', 'Mexico': 'mx', 'Micronesia (Federated States of)': 'fm', 'Monaco': 'mc',
                'Mongolia': 'mn', 'Montenegro': 'me', 'Morocco': 'ma', 'Mozambique': 'mz', 'Myanmar': 'mm',
                'Namibia': 'na', 'Nauru': 'nr', 'Nepal': 'np', 'Netherlands': 'nl', 'New Zealand': 'nz',
                'Nicaragua': 'ni', 'Niger': 'ne', 'Nigeria': 'ng', 'North Macedonia': 'mk', 'Norway': 'no',
                'Oman': 'om', 'Pakistan': 'pk', 'Palau': 'pw', 'Panama': 'pa', 'Papua New Guinea': 'pg',
                'Paraguay': 'py', 'Peru': 'pe', 'Philippines': 'ph', 'Poland': 'pl', 'Portugal': 'pt',
                'Qatar': 'qa', 'Republic of Korea': 'kr', 'Republic of Moldova': 'md', 'Romania': 'ro',
                'Russian Federation': 'ru', 'Rwanda': 'rw', 'Saint Kitts and Nevis': 'kn', 'Saint Lucia': 'lc',
                'Saint Vincent and the Grenadines': 'vc', 'Samoa': 'ws', 'San Marino': 'sm',
                'Sao Tome and Principe': 'st', 'Saudi Arabia': 'sa', 'Senegal': 'sn', 'Serbia': 'rs',
                'Seychelles': 'sc', 'Sierra Leone': 'sl', 'Singapore': 'sg', 'Slovakia': 'sk', 'Slovenia': 'si',
                'Solomon Islands': 'sb', 'Somalia': 'so', 'South Africa': 'za', 'South Sudan': 'ss', 'Spain': 'es',
                'Sri Lanka': 'lk', 'Sudan': 'sd', 'Suriname': 'sr', 'Sweden': 'se', 'Switzerland': 'ch',
                'Syrian Arab Republic': 'sy', 'Tajikistan': 'tj', 'Thailand': 'th', 'Timor-Leste': 'tl',
                'Togo': 'tg', 'Tonga': 'to', 'Trinidad and Tobago': 'tt', 'Tunisia': 'tn', 'Türkiye': 'tr',
                'Turkmenistan': 'tm', 'Tuvalu': 'tv', 'Uganda': 'ug', 'Ukraine': 'ua',
                'United Arab Emirates': 'ae', 'United Kingdom of Great Britain and Northern Ireland': 'gb',
                'United Republic of Tanzania': 'tz', 'United States of America': 'us', 'Uruguay': 'uy',
                'Uzbekistan': 'uz', 'Vanuatu': 'vu', 'Venezuela (Bolivarian Republic of)': 've', 'Viet Nam': 'vn',
                'Yemen': 'ye', 'Zambia': 'zm', 'Zimbabwe': 'zw'
            };


            let state = {
                selectedMetrics: ['Female Count', 'Male Count'],
                metricColors: {
                    'Female Count': '#ff69b4',
                    'Male Count': '#1f77b4',
                    'Total Count': '#ff7f0e',
                    'Female Percent': '#2ca02c',
                    'Male Percent': '#d62728'
                },
                chartType: 'stack',
                region: 'All',
                displayMode: 'Top',
                nValue: 15,
                searchTerm: '',
                activeTab: 'Chart'
            };

            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const nRangeContainer = document.getElementById('n-range-container');
            const spotlightModal = document.getElementById('spotlight-modal');

            // --- Main Setup Function ---
            async function initializeApp() {
                lucide.createIcons(); // Initialize icons
                setupEventListeners();
                renderMetricsCheckboxes();
                renderColorPickers();
                try {
                    // Load the new enriched data file
                    const data = await d3.csv('./UN_Bluebook_Data_rich.csv');
                    allData = data.map(d => ({
                        ...d,
                        'Female Count': +d['Female Count'] || 0,
                        'Male Count': +d['Male Count'] || 0,
                        'Total Count': +d['Total Count'] || 0,
                        'Female Percent': d['Female Percent'] ? +d['Female Percent'].replace('%', '') : 0,
                        'Male Percent': d['Male Percent'] ? +d['Male Percent'].replace('%', '') : 0,
                        'Population': +d['Population'] || 0
                    }));
                    
                    populateRegionSelect();
                    document.getElementById('nRange').max = allData.length;
                    document.getElementById('loading').classList.add('hidden');
                    updateVisualizations();
                    
                } catch (error) {
                    console.error("Error loading data:", error);
                    document.getElementById('loading').textContent = "Error loading data. Please check the console.";
                }
            }
            
            // --- UI Setup & Event Listeners ---
            function setupEventListeners() {
                // Sidebar toggles
                document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
                document.getElementById('sidebar-close').addEventListener('click', toggleSidebar);
                sidebarOverlay.addEventListener('click', toggleSidebar);

                // Filter controls
                document.getElementById('chartTypeSelect').addEventListener('change', (e) => handleStateChange('chartType', e.target.value));
                document.getElementById('regionSelect').addEventListener('change', (e) => handleStateChange('region', e.target.value));
                document.getElementById('nRange').addEventListener('input', (e) => {
                    document.getElementById('nValue').textContent = e.target.value;
                });
                document.getElementById('nRange').addEventListener('change', (e) => handleStateChange('nValue', Number(e.target.value)));
                document.getElementById('searchInput').addEventListener('input', (e) => handleStateChange('searchTerm', e.target.value));
                document.getElementById('download-csv').addEventListener('click', downloadCSV);

                // Display mode buttons
                document.getElementById('displayModeContainer').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const mode = e.target.dataset.mode;
                        handleStateChange('displayMode', mode);
                        
                        document.querySelectorAll('#displayModeContainer button').forEach(btn => {
                            btn.className = 'w-full py-1 text-sm rounded-md bg-transparent text-gray-600 hover:bg-gray-200';
                        });
                        e.target.className = 'w-full py-1 text-sm rounded-md bg-white text-blue-600 shadow';
                        nRangeContainer.classList.toggle('hidden', mode === 'All');
                    }
                });

                // Tabs
                document.getElementById('tabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-button')) {
                        const tabName = e.target.dataset.tab;
                        handleStateChange('activeTab', tabName);
                        
                        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');

                        document.querySelectorAll('.panel').forEach(panel => panel.classList.add('hidden'));
                        document.getElementById(`${tabName.toLowerCase()}-panel`).classList.remove('hidden');
                        
                        // Redraw on tab change to ensure correct sizing
                        if(tabName === 'Chart' || tabName === 'Map') {
                             setTimeout(updateVisualizations, 50);
                        }
                    }
                });
                
                // Spotlight Modal close events
                document.getElementById('spotlight-close').addEventListener('click', hideSpotlight);
                spotlightModal.addEventListener('click', (e) => {
                    if (e.target === spotlightModal) {
                        hideSpotlight();
                    }
                });

            }

            function handleStateChange(key, value) {
                state[key] = value;
                updateVisualizations();
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('opacity-0');
                sidebarOverlay.classList.toggle('pointer-events-none');
            }

            // --- Data Processing & Rendering ---
            function filterAndSortData() {
                let data = [...allData];
                if (state.region !== 'All') {
                    data = data.filter(d => d.Group === state.region);
                }
                if (state.searchTerm) {
                    data = data.filter(d => d.Country.toLowerCase().includes(state.searchTerm.toLowerCase()));
                }
                data.sort((a, b) => b['Total Count'] - a['Total Count']);
                if (state.displayMode === 'Top') {
                    data = data.slice(0, state.nValue);
                } else if (state.displayMode === 'Bottom') {
                    data = data.slice(-state.nValue);
                }
                filteredData = data;
            }

            function updateVisualizations() {
                filterAndSortData();
                drawChart();
                drawTable();
                drawMap();
            }

            function populateRegionSelect() {
                const regions = Array.from(new Set(allData.map(d => d.Group))).sort();
                const select = document.getElementById('regionSelect');
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    select.appendChild(option);
                });
            }
            
            function renderMetricsCheckboxes() {
                 const container = document.getElementById('metrics-container');
                 container.innerHTML = '';
                 ALL_METRICS.forEach(metric => {
                    const id = `metric-${metric.replace(/\s/g, '-')}`;
                    const isChecked = state.selectedMetrics.includes(metric);
                    const label = document.createElement('label');
                    label.htmlFor = id;
                    label.className = "flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors";
                    label.innerHTML = `
                        <input id="${id}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-gray-800">${metric}</span>
                    `;
                    label.querySelector('input').addEventListener('change', () => {
                         if (state.selectedMetrics.includes(metric)) {
                            state.selectedMetrics = state.selectedMetrics.filter(m => m !== metric);
                         } else {
                            state.selectedMetrics.push(metric);
                         }
                         renderColorPickers();
                         updateVisualizations();
                    });
                    container.appendChild(label);
                 });
            }

            function renderColorPickers() {
                const container = document.getElementById('color-pickers-container');
                container.innerHTML = '';
                state.selectedMetrics.forEach(metric => {
                    const id = `color-${metric.replace(/\s/g, '-')}`;
                    const color = state.metricColors[metric];

                    const wrapper = document.createElement('div');
                    wrapper.className = "flex items-center justify-between p-1";

                    const label = document.createElement('label');
                    label.htmlFor = id;
                    label.textContent = metric;
                    label.className = "text-sm text-gray-700";

                    const input = document.createElement('input');
                    input.id = id;
                    input.type = 'color';
                    input.value = color;
                    
                    input.addEventListener('change', (e) => {
                        state.metricColors[metric] = e.target.value;
                        if(state.activeTab === 'Chart') {
                            drawChart();
                        }
                    });

                    wrapper.appendChild(label);
                    wrapper.appendChild(input);
                    container.appendChild(wrapper);
                });
            }

            function drawChart() {
                const panel = document.getElementById('chart-panel');
                if (!filteredData.length || !state.selectedMetrics.length) {
                    panel.innerHTML = `<div class="text-center text-gray-500 p-10">Select metrics and filters to see the chart.</div>`;
                    return;
                }
                
                const layout = {
                    title: { text: `${state.selectedMetrics.join(' & ')} by Country`, font: { size: 20, color: '#333' }, x: 0.05 },
                    height: 500,
                    autosize: true,
                    margin: { l: 150, r: 40, b: 50, t: 80 },
                    legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                };
                const config = { responsive: true, displaylogo: false };

                let plotData, plotLayout;

                if (state.chartType === 'pie') {
                    plotData = [{
                        labels: filteredData.map(d => d.Country),
                        values: filteredData.map(d => d['Total Count']),
                        type: 'pie',
                        hole: .4,
                        hoverinfo: 'label+percent+value', textinfo: 'label+percent', textposition: 'inside'
                    }];
                    plotLayout = { ...layout, title: { ...layout.title, text: 'Total Count Distribution'} };
                } else {
                    const yCategories = filteredData.map(d => d.Country).reverse();
                    plotData = state.selectedMetrics.map(metric => ({
                        x: filteredData.map(d => d[metric]).reverse(),
                        y: yCategories, name: metric, type: 'bar', orientation: 'h',
                        marker: {
                            color: state.metricColors[metric]
                        }
                    }));
                    plotLayout = {
                        ...layout,
                        barmode: state.chartType === 'percent' ? 'stack' : state.chartType,
                        barnorm: state.chartType === 'percent' ? 'percent' : '',
                        yaxis: { categoryorder: 'array', categoryarray: yCategories }
                    };
                }

                Plotly.react(panel, plotData, plotLayout, config);
                
                // Attach click listener once after chart is drawn
                if (!plotlyListenerAttached) {
                    panel.on('plotly_click', (data) => {
                        if (data.points.length > 0) {
                            const country = state.chartType === 'pie' ? data.points[0].label : data.points[0].y;
                            showSpotlight(country);
                        }
                    });
                    plotlyListenerAttached = true;
                }
            }

            function drawTable() {
                const panel = document.getElementById('table-panel');
                if (!filteredData.length) {
                    panel.innerHTML = `<div class="text-center text-gray-500 p-10">No data available.</div>`;
                    return;
                }
                
                const columns = ['', 'Country', 'Group', 'Female Count', 'Male Count', 'Total Count'];
                const header = `<thead><tr class="bg-gray-50">${columns.map(c => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${c}</th>`).join('')}</tr></thead>`;
                const body = `<tbody>${filteredData.map(row => {
                    const countryCode = countryCodeMap[row.Country] || '';
                    const flagHtml = countryCode ? `<span class="fi fi-${countryCode} fis rounded-sm shadow-sm" style="width: 32px; height: 24px; display: inline-block;"></span>` : '<div class="w-8 h-6 bg-gray-200 rounded-sm"></div>';
                    return `
                    <tr class="hover:bg-gray-100 cursor-pointer" data-country="${row.Country}">
                        <td class="px-6 py-4">${flagHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-bold">${row.Country}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.Group}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row['Female Count'].toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row['Male Count'].toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row['Total Count'].toLocaleString()}</td>
                    </tr>`
                }).join('')}</tbody>`;
                
                panel.innerHTML = `<table class="min-w-full divide-y divide-gray-200">${header}${body}</table>`;

                panel.querySelectorAll('tbody tr').forEach(row => {
                    row.addEventListener('click', () => {
                         const country = row.dataset.country;
                         showSpotlight(country);
                    });
                });
            }

            function drawMap() {
                const panel = document.getElementById('map-panel');
                const metric = state.selectedMetrics[0];
                if (!filteredData.length || !metric) {
                    panel.innerHTML = `<div class="text-center text-gray-500 p-10">Select a metric to display on the map.</div>`;
                    return;
                }
                const mapData = [{
                    type: 'choropleth', locations: filteredData.map(d => d.Country), locationmode: 'country names',
                    z: filteredData.map(d => d[metric]), text: filteredData.map(d => d.Country),
                    colorscale: 'Viridis', reversescale: true,
                    hovertemplate: '<b>%{text}</b><br>' + `${metric}: %{z:,}` + '<extra></extra>',
                    marker: { line: { color: 'white', width: 0.5 } },
                    colorbar: { title: metric, thickness: 15 }
                }];
                const layout = {
                    title: { text: `${metric} by Country`, font: { size: 20, color: '#333' }, x: 0.05 },
                    height: 600,
                    geo: { showframe: false, showcoastlines: true, projection: { type: 'mercator' } },
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                };
                Plotly.react(panel, mapData, layout, { responsive: true, displaylogo: false });
                
                panel.on('plotly_click', (data) => {
                    if (data.points.length > 0) {
                        showSpotlight(data.points[0].text);
                    }
                });

            }
            
            function downloadCSV() {
                const csv = d3.csvFormat(filteredData);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "un_bluebook_filtered_data.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // --- Spotlight Modal Functions ---
            function createStatRow(label, value, icon = null) {
                if (!value) return ''; // Don't render if no value
                const iconHtml = icon ? `<i data-lucide="${icon}" class="w-4 h-4 mr-2 text-gray-500"></i>` : '';
                return `
                    <div class="flex justify-between items-start text-md py-1">
                        <span class="font-semibold text-gray-600 flex items-center shrink-0">${iconHtml}${label}:</span>
                        <span class="font-mono text-gray-800 text-right ml-4">${value}</span>
                    </div>
                `;
            }
            
            function createLinkRow(label, value, href, icon = null) {
                if (!value) return ''; // Don't render if no value
                const iconHtml = icon ? `<i data-lucide="${icon}" class="w-4 h-4 mr-2 text-gray-500"></i>` : '';
                return `
                     <div class="flex justify-between items-start text-md py-1">
                        <span class="font-semibold text-gray-600 flex items-center shrink-0">${iconHtml}${label}:</span>
                        <a href="${href}" target="_blank" rel="noopener noreferrer" class="font-mono text-blue-600 hover:underline truncate ml-4 text-right">${value}</a>
                    </div>
                `;
            }

            function showSpotlight(countryName) {
                const countryData = allData.find(d => d.Country === countryName);
                if (!countryData) return;
                
                const countryCode = countryCodeMap[countryData.Country] || '';
                const flagHtml = countryCode ? `<span class="fi fi-${countryCode} fis rounded-md shadow-md mr-4" style="width: 40px; height: 30px; display: inline-block;"></span>` : '';

                document.getElementById('spotlight-title').innerHTML = `
                    ${flagHtml}
                    <span>${countryData.Country}</span>
                `;
                
                const statsUnContainer = document.getElementById('spotlight-stats-un');
                statsUnContainer.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-1 mb-2">UN Contribution</h3>
                    ${createStatRow('Total Personnel', countryData['Total Count'].toLocaleString())}
                    ${createStatRow('Female Personnel', `${countryData['Female Count'].toLocaleString()} (${countryData['Female Percent'].toFixed(1)}%)`)}
                    ${createStatRow('Male Personnel', `${countryData['Male Count'].toLocaleString()} (${countryData['Male Percent'].toFixed(1)}%)`)}
                `;

                const statsCountryContainer = document.getElementById('spotlight-stats-country');
                statsCountryContainer.innerHTML = `
                     <h3 class="text-xl font-semibold text-gray-700 border-b pb-1 mb-2">Country Information</h3>
                    ${createStatRow('Capital', countryData.Capital, 'map-pin')}
                    ${createStatRow('Region', countryData.Region, 'globe-2')}
                    ${createStatRow('Subregion', countryData['Sub-region'], 'map')}
                    ${createStatRow('Population', countryData.Population.toLocaleString(), 'users')}
                `;
                
                const missionContainer = document.getElementById('spotlight-stats-mission');
                missionContainer.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-1 mb-2">Mission Contact</h3>
                    ${createStatRow('Entity', countryData.MC_EntityShort)}
                    ${createStatRow('Full Entity Name', countryData.MC_EntityLong)}
                    ${createStatRow('Address', countryData.MC_Address, 'building')}
                    ${createStatRow('Telephone', countryData.MC_Telephone, 'phone')}
                    ${createStatRow('Fax', countryData.MC_Telefax, 'printer')}
                    ${createStatRow('Membership Date', countryData.MC_MembershipDate, 'calendar')}
                    ${createStatRow('National Holiday', countryData.MC_Holiday, 'cake')}
                    ${createLinkRow('Website', countryData.MC_WebSite, countryData.MC_WebSite, 'external-link')}
                    ${createLinkRow('Social Media', countryData.MC_SocialMedia, countryData.MC_SocialMedia, 'at-sign')}
                    ${createLinkRow('Email', countryData.MC_eMail, 'mailto:' + countryData.MC_eMail, 'mail')}
                    ${createStatRow('UN Correspondence', countryData.MC_UNCorrespondenceLanguage, 'languages')}
                `;


                const spotlightChart = document.getElementById('spotlight-chart');
                const pieData = [{
                    values: [countryData['Female Count'], countryData['Male Count']],
                    labels: ['Female', 'Male'],
                    type: 'pie',
                    hole: .4,
                    marker: {
                        colors: [state.metricColors['Female Count'], state.metricColors['Male Count']]
                    },
                    textinfo: 'label+percent',
                    textposition: 'inside',
                    hoverinfo: 'label+value'
                }];
                const pieLayout = {
                    title: 'Gender Distribution of Deployed Personnel',
                    height: 280,
                    margin: { t: 50, b: 20, l: 20, r: 20 },
                    showlegend: true,
                    legend: { x: 0.5, y: -0.1, xanchor: 'center', orientation: 'h'},
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                };
                Plotly.newPlot(spotlightChart, pieData, pieLayout, {staticPlot: true, displaylogo: false});

                spotlightModal.classList.remove('hidden');
                lucide.createIcons();
            }

            function hideSpotlight() {
                spotlightModal.classList.add('hidden');
            }


            // --- Start the App ---
            initializeApp();
        });
    </script>
</body>
</html>
